<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RE Haifa Hub — Стратегия</title>

  <!-- ВАЖНО: фиксируем версию marked (устойчиво работает с нашим кодом) -->
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f7fafc; color:#223; }
    header { background: rgba(67,160,71,0.85); color:#fff; padding: 2rem 1rem; text-align:center; }
    header h1 { margin:0; font-size:2rem; }
    header a { color:#fff; text-decoration: underline; }
    main {
      max-width: 980px; margin: 1.5rem auto; background:#fff;
      border-radius: 12px; box-shadow: 0 4px 16px rgba(67,160,71,0.20);
      padding: 1.5rem 1.75rem;
    }
    .muted { color:#789; }
    .error { background:#fff3f3; border-left:6px solid #d33; padding: 12px 14px; border-radius:10px; }
    #content h1, #content h2, #content h3 { margin-top: 1.2em; }
    #content table { border-collapse: collapse; width: 100%; overflow-x:auto; display:block; }
    #content th, #content td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    #content code { background: #f2f6f3; padding: 0.1em 0.3em; border-radius: 6px; }
    #content pre code { display:block; padding: 1em; overflow:auto; }
    #content details { margin: 0.6em 0; padding: 0.4em 0.6em; background:#f7fafc; border-radius: 10px; }
    #content summary { cursor:pointer; font-weight: 700; }
  </style>
</head>
<body>
  <header>
    <h1>Израиль на пути к ЦЭ — пакет документов</h1>
    <div class="muted" style="color: rgba(255,255,255,0.9); margin-top: 0.5rem;">
      <a href="index.html">← На главную</a>
    </div>
  </header>

  <main>
    <div id="status" class="muted">Загрузка…</div>
    <div id="content"></div>
  </main>

  <script>
    (function () {
      const statusEl = document.getElementById('status');
      const contentEl = document.getElementById('content');

      // Твой главный файл (судя по скриншотам он реально существует именно так)
      const ENTRY = 'Strategy/Strateg.md';

      let currentMdFile = ENTRY;       // какой md сейчас показан
      let currentMdDir  = 'Strategy/'; // папка текущего md

      function stripFrontMatter(md) {
        return md.replace(/^---\s*[\s\S]*?\n---\s*/m, '');
      }

      function isExternal(href) {
        return /^(https?:\/\/|mailto:|tel:)/i.test(href);
      }

      function resolveRelative(href) {
        // превращаем относительную ссылку в путь относительно корня сайта
        // основываясь на папке текущего md-файла
        const base = 'https://example.com/' + currentMdDir;
        const u = new URL(href, base);
        return u.pathname.replace(/^\//, ''); // без начального /
      }

      function mdCandidates(path) {
        // если ссылка без расширения — попробуем и так, и с .md
        const p = path.split('#')[0];
        const out = [p];
        if (!/\.[a-z0-9]+$/i.test(p)) out.push(p + '.md');
        return [...new Set(out)];
      }

      async function fetchFirstOk(cands) {
        for (const c of cands) {
          try {
            const r = await fetch(c, { cache: 'no-cache' });
            if (r.ok) return { path: c, text: await r.text() };
          } catch(e) {}
        }
        return null;
      }

      function showError(msg) {
        statusEl.textContent = '';
        contentEl.innerHTML = `
          <div class="error">
            <b>Ошибка загрузки.</b><br/>
            <div style="margin-top:8px">${msg}</div>
          </div>
        `;
      }

      function rewriteLinksInsideContent() {
        // все относительные ссылки на .md делаем “внутренними” через hash
        const links = contentEl.querySelectorAll('a[href]');
        links.forEach(a => {
          const href = a.getAttribute('href');
          if (!href) return;
          if (href.startsWith('#')) return;
          if (isExternal(href)) return;
          if (href.startsWith('/')) return; // оставляем как есть (если вдруг)

          // относительная ссылка из md
          const resolved = resolveRelative(href);

          // если это md или ссылка без расширения — отправляем в hash (чтобы не было 404)
          const looksMd = resolved.toLowerCase().endsWith('.md') || !/\.[a-z0-9]+$/i.test(resolved);
          if (looksMd) {
            a.setAttribute('href', '#/' + resolved);
          } else {
            // иначе это может быть html/картинка и т.п. — нормализуем путь
            a.setAttribute('href', resolved);
          }
        });

        // картинки: делаем относительными к папке md
        const imgs = contentEl.querySelectorAll('img[src]');
        imgs.forEach(img => {
          const src = img.getAttribute('src');
          if (!src) return;
          if (isExternal(src) || src.startsWith('/')) return;
          img.setAttribute('src', resolveRelative(src));
        });
      }

      async function loadMd(path) {
        statusEl.textContent = 'Загрузка…';
        contentEl.innerHTML = '';

        const candidates = mdCandidates(path);
        const hit = await fetchFirstOk(candidates);
        if (!hit) {
          showError('Не найден файл: ' + candidates.join(' | '));
          return;
        }

        currentMdFile = hit.path;
        currentMdDir = currentMdFile.includes('/')
          ? currentMdFile.slice(0, currentMdFile.lastIndexOf('/') + 1)
          : '';

        let md = stripFrontMatter(hit.text);

        if (!window.marked) {
          showError('marked не загрузился. Проверь, не блокирует ли браузер jsdelivr.');
          return;
        }

        contentEl.innerHTML = marked.parse(md);
        rewriteLinksInsideContent();
        statusEl.textContent = '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function getHashPath() {
        const h = location.hash || '';
        if (!h.startsWith('#/')) return null;
        return h.slice(2); // убрать "#/"
      }

      window.addEventListener('hashchange', () => {
        const p = getHashPath();
        if (p) loadMd(p);
      });

      // стартовая загрузка
      const start = getHashPath();
      loadMd(start || ENTRY);
    })();
  </script>
</body>
</html>
